<?xml version="1.0"?>
<s:Window xmlns:fx="http://ns.adobe.com/mxml/2009"
          xmlns:s="library://ns.adobe.com/flex/spark"
          showStatusBar="false"
          creationComplete="onCreationComplete(event)">
    <fx:Script><![CDATA[
        import data.ProjectData;

        import mx.events.FlexEvent;

        private var projectData:ProjectData;
        private var app;

        private function onCreationComplete(event:FlexEvent):void
        {
        }

        public function start(swfBytes:ByteArray, projectData:ProjectData):void
        {
            var context:LoaderContext = new LoaderContext(false, new ApplicationDomain());
            context.allowLoadBytesCodeExecution = true;
            context.allowCodeImport = true;

            swfLoader.loaderContext = context;
            swfLoader.source = swfBytes;
            swfLoader.load();

            this.projectData = projectData;
        }

        private function onSwfLoaderComplete(event:Event):void
        {
            swfLoader.visible = swfLoader.includeInLayout = true;

            swfLoader.content.addEventListener(FlexEvent.APPLICATION_COMPLETE, onSwfApplicationComplete);
        }

        private function onSwfApplicationComplete(event:Event):void
        {
            // Load projectData
            app = event.target.application;
            app.load(projectData);
            app.callbackSave = onSave;
        }

        private function onSave():void
        {
            projectData.content = app.content;
            projectData.save();
        }
        ]]></fx:Script>

    <s:SWFLoader id="swfLoader"
                 visible="false"
                 includeInLayout="false"
                 autoLoad="false"
                 width="100%"
                 height="100%"
                 scaleContent="false"
                 complete="onSwfLoaderComplete(event)"
                 maintainAspectRatio="false"
                 trustContent="true"/>
</s:Window>